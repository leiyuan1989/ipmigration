#! tvf
namespace import tvf::*

VERBATIM {
//=================================================================================
//|                                                                               |
//|  0.13um 1P8M Calibre DRC rule file for                                        |
//|                                                                               |
//|       SMIC:    0.11um/0.13um Logic & Mix-Signal 1.2/2.5/3.3v generic 	      |
//|			and 1.5/3.3v low leakage Design Rule			                      |
//|       Doc. No.:       TD-LO13-DR-2001      Rev.: 21   Tech DevRev: 1.25       |
//|                                                                               |
//|                                                                               |
//|                                                                               |
//|       Calibre tool version:   2016.3_19.12                                    |
//|                                                                               |
//|===============================================================================|
//|                                                                               |
//|    DISCLAIMER                                                                 |
//|                                                                               |
//|   SMIC hereby provides the quality information to you but makes no claims,    |
//| promises or guarantees about the accuracy, completeness, or adequacy of the   |
//| information herein. The information contained herein is provided on an "AS IS"|
//| basis without any warranty, and SMIC assumes no obligation to provide support |
//| of any kind or otherwise maintain the information.                            |
//|                                                                               |
//|   SMIC disclaims any representation that the information does not infringe any|
//| intellectual property rights or proprietary rights of any third parties.SMIC  |
//| makes no other warranty, whether express, implied or statutory as to any      |
//| matter whatsoever, including but not limited to the accuracy or sufficiency of|
//| any information or the merchantability and fitness for a particular purpose.  |
//| Neither SMIC nor any of its representatives shall be liable for any cause of  |
//| action incurred to connect to this service.                                   |
//|                                                                               |
//|===============================================================================|
//|                                                                               |
//|    STATEMENT OF USE AND CONFIDENTIALITY                                       |
//|                                                                               |
//|   The following/attached material contains confidential and proprietary       |
//| information of SMIC. This material is based upon information which SMIC       |
//| considers reliable, but SMIC neither represents nor warrants that such        |
//| information is accurate or complete, and it must not be relied upon as such.  |
//| This information was prepared for informational purposes and is for the use by|
//| SMIC's customer only. SMIC reserves the right to make changes in the          |
//| information at any time without notice.                                       |
//|   No part of this information may be reproduced, transmitted, transcribed,    |
//| stored in a retrieval system, or translated into any human or computer        |
//| language, in any form or by any means, electronic, mechanical, magnetic,      |
//| optical, chemical, manual, or otherwise, without the prior written consent of |
//| SMIC. Any unauthorized use or disclosure of this material is strictly         |
//| prohibited and may be unlawful. By accepting this material, the receiving     |
//| party shall be deemed to have acknowledged, accepted, and agreed to be bound  |
//| by the foregoing limitations and restrictions. Thank you.                     |
//|                                                                               |
//|===============================================================================|
//|                                                                               |
//|   This file includes SVRF/TVF Technology under license by Mentor Graphics     |
//| Corporation.  "SVRF/TVF Technology" shall mean Mentor Graphics' Standard      |
//| Verification Rule Format ("SVRF") and Tcl Verification Format ("TVF")         |
//| proprietary syntaxes for expressing process rules.  You shall not use SVRF/TVF|
//| Technology unless you are a Mentor Graphics customer with a license to use the|
//| applicable Mentor Graphics software. The exact terms of your obligations and  |
//| rights are governed by your respective license.  You shall not use SVRF/TVF   |
//| Technology except: (a) for your internal business purposes and (b) for use    |
//| with Mentor Graphics' Calibre tools. All SVRF/TVF Technology constitutes or   |
//| contains trade secrets and confidential information of Mentor Graphics or its |
//| licensors. You shall not make SVRF/TVF Technology available in any form to any|
//| person other than your employees and on-site contractors, excluding Mentor    |
//| Graphics competitors, whose job performance requires access and who are under |
//| obligations of confidentiality.                                               |
//|                                                                               |
//|===============================================================================|
//| Revision History:								  |
//| Rev:	Date:		Who:		What:				  |
//|-------------------------------------------------------------------------------|
//|V1.25_0   2017-09-1    SS_Yang              1.update the switch setting for DRC standardization|
//|                                            2.Update the DR version and calibre_tool_version
//|V1.24_1   2016-03-18    Liu Li              no update                          |	
//|V1.24_0   2015-11-20    Weili Kong	       initial				  |
//|										  |
//|===============================================================================|
}

#---$Date: 2014/10/29---
#=========================================================================================#
#                              Choice 1: For Metal Option                                 # 
#-----------------------------------------------------------------------------------------#
# Note 1: This rule file support 1P8M,1P7M,1P6M,1P5M,1P4M process Calibre DRC check. 
# Note 2: Below switches are for users, please set them based on the chip design.
# Note 3: For 1P8M,the switch "MT2",you can choose TM2(122)/TV2(123) or M8(68)/V7(76) as top metal2/via2 
#                                                  TM1(120)/TV1(121) or M7(67)/V6(75) as top metal1/via1
#         For 1P6M,the switch "MT1 or MTT1",you can choose TM2(122)/TV2(123) or M6(66)/V6(74) as top metal2/via2 


set metal_counts 8			 ;#Valid value is: { 8,7,6,5,4 }
                            ; #------ Total metal counts ----------------------------------
			    ; #For 1P8M process, "metal_counts = 8".
			    ; #For 1P7M process, "metal_counts = 7".
                            ; #For 1P6M process, "metal_counts = 6".
                            ; #For 1P5M process, "metal_counts = 5".
                            ; #For 1P4M process, "metal_counts = 4".
set top_metal MT1			;#Valid value is: { MT1,MTT1,MT2 }
                            ; #------- Top metal option -----------------------------------
                            ; #For "MT1",use 1 top metal (thickness=0.9um) as top metal
			    ; #For "MTT1",use 1 ultra top metal (thickness=3um) as top meta
			    ; #For "MT2",use 2 top metal.

if { [string equal $metal_counts 5] == 1 } {
VERBATIM {
#DEFINE MIM two_mask	//Valid value is: { one_mask ,two_mask}	
			    //---------MIM option----------------------------------------
			    // #MiM selection,
			    //; #Defaults for check rule one_mask;
			    //; #If you use two mask MIM, please change it into "two_mask";
			    //; #If you use stacked MIM, please change it into "s_mask";
			    //; #NOTE:"s_mask" is not allowed used for "MT2".



}
} elseif { [string equal $metal_counts 4] == 1 } {
VERBATIM {
#DEFINE MIM two_mask	//Valid value is: { one_mask}	
			    //---------MIM option----------------------------------------
			    // #MiM selection,
			    //; #Defaults for check rule one_mask;
			    //; #If you use two mask MIM, please change it into "two_mask";
			    //; #If you use stacked MIM, please change it into "s_mask";
			    //; #NOTE:"s_mask" is not allowed used for "MT2".



}
} elseif { [string equal $top_metal MT2] == 1 } {
VERBATIM {
#DEFINE MIM two_mask	//Valid value is: { one_mask,two_mask}	
			    //---------MIM option----------------------------------------
			    // #MiM selection,
			    //; #Defaults for check rule one_mask;
			    //; #If you use two mask MIM, please change it into "two_mask";
			    //; #If you use stacked MIM, please change it into "s_mask";
			    //; #NOTE:"s_mask" is not allowed used for "MT2".


}
} else {
VERBATIM {
#DEFINE MIM two_mask	//Valid value is: { one_mask ,two_mask , s_mask }	
			    //---------MIM option----------------------------------------
			    // #MiM selection,
			    //; #Defaults for check rule one_mask;
			    //; #If you use two mask MIM, please change it into "two_mask";
			    //; #If you use stacked MIM, please change it into "s_mask";
			    //; #NOTE:"s_mask" is not allowed used for "MT2".



}
}
#---------------------------- End of Switch Setting --------------------------------------#
#=========================================================================================#
#--------------------------------------------------------------------------------------------
# Usher should not modify the below script.
# Vaild metal option setting control.
# Below matrix shows all of available combinations for choice.
set combinations {
{8 MT2}
{8 MT1}
{8 MTT1}
{7 MT2}
{7 MT1}
{7 MTT1}
{6 MT2}
{6 MT1}
{6 MTT1}
{5 MT2}
{5 MT1}
{5 MTT1}
{4 MT1}
{4 MTT1}
}
if { [lsearch -start 0 -all -inline $combinations "$metal_counts $top_metal"] eq "" } {
  puts "\nWrong metal option combination. Please check the setting for metal options.\n"
  exit
}

VERBATIM {
//=>   1.2V/1.5V core   :  no DG
//=>   2.5V/3.3V   :  DG only
//*************************************
//     DIRECTIVE SECTION
//*************************************

LAYOUT PATH "*.gds"
LAYOUT PRIMARY "*"
LAYOUT SYSTEM GDSII 

DRC RESULTS DATABASE "ant_CAL.OUT" ASCII 
DRC SUMMARY REPORT "ant_CAL.SUM"
     

DRC MAXIMUM RESULTS 1000
DRC MAXIMUM VERTEX 199

//************************************
//    INPUT LAYER STATEMENTS
//************************************

LAYER	MAP	10 DATATYPE 0 510
LAYER   MAP     12 DATATYPE 0 511
LAYER   MAP     13 DATATYPE 0 512
LAYER	AAi	510 511 512  //	Active Area 

LAYER	MAP	30 DATATYPE 0 530  //Poly Gate
LAYER 	GTi	530

LAYER   MAP     31      DATATYPE 0  509
LAYER   P2      509

LAYER   MAP     29  DATATYPE 0 529
LAYER   DG      529

LAYER	MAP	50 DATATYPE 0 500
LAYER   CT 	500  	//Contact 

LAYER	MAP	61 DATATYPE 0 610
LAYER   M1i 610  	//	Metal-1

LAYER	MAP	62 DATATYPE 0 620
LAYER   M2i 620  	//	Metal-2

LAYER	MAP	63 DATATYPE 0 630
LAYER   M3i	630  	//	Metal-3

LAYER	MAP	64 DATATYPE 0 640
LAYER	M4i	640	//	

LAYER	MAP	65 DATATYPE 0 650
LAYER	M5i	650

LAYER	MAP	66 DATATYPE 0 660
LAYER	M6i	660

LAYER	MAP	67 DATATYPE 0 670
LAYER	M7i	670

LAYER	MAP	68 DATATYPE 0 680
LAYER	M8i	680

LAYER	MAP	120 DATATYPE 0 1200
LAYER	TM1i	1200

LAYER	MAP	122 DATATYPE 0 1220
LAYER	TM2i	1220

LAYER	MAP	70 DATATYPE 0 700	
LAYER   V1 	 700  	//	Via-1 Hole

LAYER	MAP	71 DATATYPE 0 710
LAYER   V2 	710  	//	Via-2 Hole

LAYER	MAP	72 DATATYPE 0 720
LAYER   V3  	720	//	Top via

LAYER	MAP	73 DATATYPE 0 730
LAYER   V4  	730	

LAYER	MAP	74 DATATYPE 0 740
LAYER   V5  	740

LAYER	MAP	75 DATATYPE 0 750
LAYER   V6  	750

LAYER	MAP	76 DATATYPE 0 760
LAYER   V7  	760

LAYER	MAP	121 DATATYPE 0 1210
LAYER   TV1i  	1210

LAYER	MAP	123 DATATYPE 0 1230
LAYER   TV2i  	1230

LAYER	MAP	58 DATATYPE 0 580
LAYER   MIM 	580      // Top Plate of MiM capacitor

LAYER	MAP	80 DATATYPE 0 800
LAYER   PA 	800  	//	Passivation / Pad

LAYER   MAP     40   DATATYPE 0 400 
LAYER   SN      400 

LAYER   MAP     43   DATATYPE 0 430 
LAYER   SP      430

LAYER   MAP     10  DATATYPE 1   1011
LAYER   AADUM   1011

LAYER   MAP     30  DATATYPE 1   301
LAYER   GTDUM   301 

LAYER   MAP     61  DATATYPE 1   611
LAYER   M1DUM   611

LAYER   MAP     61 DATATYPE 2 612
LAYER   M1SLOT  612     //M1 slot

LAYER   MAP     62  DATATYPE 1   621
LAYER   M2DUM   621

LAYER   MAP     62 DATATYPE 2 622
LAYER   M2SLOT  622		//M2 Slot

LAYER   MAP     63  DATATYPE 1   631
LAYER   M3DUM   631

LAYER   MAP     63 DATATYPE 2 632
LAYER   M3SLOT  632		//M3 Slot

LAYER   MAP     64  DATATYPE 1   641
LAYER   M4DUM   641

LAYER   MAP     64 DATATYPE 2 642
LAYER   M4SLOT  642	//M4 Slot

LAYER   MAP     65 DATATYPE 1 651
LAYER   M5DUM   651

LAYER   MAP     65 DATATYPE 2 652
LAYER   M5SLOT  652

LAYER   MAP     66  DATATYPE 1 661
LAYER   M6DUM   661

LAYER   MAP     66 DATATYPE 2 662
LAYER   M6SLOT  662

LAYER   MAP     67  DATATYPE 1 671
LAYER   M7DUM   671

LAYER   MAP     67 DATATYPE 2 672
LAYER   M7SLOT  672

LAYER   MAP     68  DATATYPE 1 681
LAYER   M8DUM   681

LAYER   MAP     68 DATATYPE 2 682
LAYER   M8SLOT  682

LAYER   MAP     120  DATATYPE 1 1201
LAYER   TM1DUM  1201

LAYER   MAP     120 DATATYPE 2 1202
LAYER   TM1SLOT 1202

LAYER   MAP     122  DATATYPE 1   1221
LAYER   TM2DUM  1221

LAYER   MAP     122 DATATYPE 2 1222
LAYER   TM2SLOT 1222


AA = COPY AAi
GT = COPY GTi
}

set metal_list " "
set via_list " "

if { ([string equal $top_metal MT1] == 1) || ([string equal $top_metal MTT1] == 1) } {
  for { set j 1 } { 0 < [expr $metal_counts - $j] } { incr j } {
   SETLAYER M${j} = M${j}i NOT M${j}SLOT
   lappend metal_list M$j
   if { $j < [expr $metal_counts - 1] } {
   lappend via_list V$j
   }
  }
   SETLAYER TM2 = (M${metal_counts}i NOT M${metal_counts}SLOT) OR (TM2i NOT TM2SLOT)
   SETLAYER TV2 = V[expr $metal_counts-1] OR TV2i
   lappend metal_list TM2
   lappend via_list TV2
} elseif { [string equal $top_metal MT2] == 1 } {
  for { set j 1 } { 1 < [expr $metal_counts - $j] } { incr j } {
   SETLAYER M${j} = M${j}i NOT M${j}SLOT 
   lappend metal_list M$j
   if { $j < [expr $metal_counts - 2] } {
   lappend via_list V$j
   }
  }
   SETLAYER TM1 = (M[expr $metal_counts-1]i NOT M[expr $metal_counts-1]SLOT) OR (TM1i NOT TM1SLOT)
   SETLAYER TM2 = (M${metal_counts}i NOT M${metal_counts}SLOT) OR (TM2i NOT TM2SLOT)
   SETLAYER TV1 = V[expr $metal_counts-2] OR TV1i
   SETLAYER TV2 = V[expr $metal_counts-1] OR TV2i
   lappend metal_list TM1 TM2
   lappend via_list TV1 TV2
}

if { ([string equal $top_metal MT1] == 1) || ([string equal $top_metal MTT1] == 1) } {
 VERBATIM {
#IFDEF MIM one_mask
}
    SETLAYER TV2_AND_MIM = [lindex $via_list end] AND MIM
    SETLAYER TV2_NOT_MIM = [lindex $via_list end] NOT MIM
VERBATIM {
#ENDIF
}

VERBATIM {
#IFDEF MIM two_mask
}
     SETLAYER [lindex $via_list end-1]\_AND_MIM = [lindex $via_list end-1] AND MIM
     SETLAYER [lindex $via_list end-1]\_AND_P2 = [lindex $via_list end-1] AND (P2 NOT MIM)
     SETLAYER [lindex $via_list end-1]\_NOT_MIM = [lindex $via_list end-1] NOT (P2 OR MIM)
   VERBATIM {
#ENDIF
}
VERBATIM {
#IFDEF MIM s_mask
}
     SETLAYER MIM_up = MIM ENCLOSE [lindex $via_list end-1]
     SETLAYER MIM_down = MIM ENCLOSE [lindex $via_list end-2]
     SETLAYER MIM_bot1 = MIM_up AND [lindex $metal_list end-2]
     SETLAYER MIM_bot2 = MIM_down AND [lindex $metal_list end-3]
     SETLAYER [lindex $via_list end-1]\_AND_MIM = [lindex $via_list end-1] AND MIM_up
     SETLAYER [lindex $via_list end-2]\_AND_MIM = [lindex $via_list end-2] AND MIM_down
     SETLAYER [lindex $via_list end-1]\_NOT_MIM = [lindex $via_list end-1] NOT MIM_up
     SETLAYER [lindex $via_list end-2]\_NOT_MIM = [lindex $via_list end-2] NOT MIM_down
VERBATIM {
#ENDIF
}
} elseif { [string equal $top_metal MT2] == 1 } {
VERBATIM {
#IFDEF MIM one_mask
}
     SETLAYER [lindex $via_list end-1]_AND_MIM = [lindex $via_list end-1] AND MIM
     SETLAYER [lindex $via_list end-1]_NOT_MIM = [lindex $via_list end-1] NOT MIM
VERBATIM {
#ENDIF
}
VERBATIM {
#IFDEF MIM two_mask
}
     SETLAYER [lindex $via_list end-1]\_AND_MIM = [lindex $via_list end-1] AND MIM
     SETLAYER [lindex $via_list end-1]\_AND_P2 = [lindex $via_list end-1] AND (P2 NOT MIM)
     SETLAYER [lindex $via_list end-1]\_NOT_MIM = [lindex $via_list end-1] NOT (MIM OR P2)
VERBATIM {
#ENDIF
}
}


VERBATIM {
SD = ((SN OR SP) AND AA) NOT GT
GATE = (GT AND AA) INTERACT SD == 2
GATE_IO = GATE AND DG
GATE_CORE = GATE NOT DG

DRC INCREMENTAL CONNECT YES

//*******************************************
//    LAYER DERIVATIONS AND OPERATIONS
//*******************************************

//===============================
//	GT LAYER
//===============================

CONNECT GT GATE_IO
CONNECT GT GATE_CORE
CONNECT GT GATE
ANT_GT_CORE {
@ (Poly perim*thickness / gate area) is <= 500.
   NET AREA RATIO GT GATE_CORE > 500
      [ PERIMETER(GT) * 0.175 / AREA(GATE_CORE) ] 
   RDB ANT_GT_CORE.rep GT GATE_CORE
}

ANT_GT_IO {
@ (Poly perim*thickness / gate area) is <= 500.
   NET AREA RATIO GT GATE_IO > 500
      [ PERIMETER(GT) * 0.175 / AREA(GATE_IO) ] 
   RDB ANT_GT_IO.rep GT GATE_IO
}

//=================
//    CT Layer
//=================

CONNECT CT GT

ANT_CT { 
@ (contact area / gate area) is <= 10.

  NET AREA RATIO CT GATE > 10
      [ AREA(CT) / AREA(GATE) ] 
  RDB ANT_CT.rep CT GATE
}


//=================
//    M1 Layer 
//=================

CONNECT M1 GT SD BY CT
CONNECT V1 M1
M1_DIO = NET AREA SD >0.16 // minimum effective diode 0.16um2

ANT_M1_thin { 
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)
  
 NET AREA RATIO GT M1 M1_DIO  GATE_CORE > 5000 ACCUMULATE
      [ AREA(M1) /AREA(GATE_CORE) -(AREA(M1_DIO)*400 + !!AREA(M1_DIO)*39000) ]   
  RDB ANT_M1_thick.rep GT M1 M1_DIO GATE_CORE
}  

ANT_M1_thick { 
@ The maximum ratio of cumulative metal area to the thick active poly gate(1.5v) area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate(1.5v) area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)
  
 NET AREA RATIO GT M1 M1_DIO  GATE_IO > 600 ACCUMULATE
      [ AREA(M1) /AREA(GATE_IO) -(AREA(M1_DIO)*400 + !!AREA(M1_DIO)*43400) ]   
  RDB ANT_M1_thin.rep GT M1 M1_DIO GATE_IO
}


//=================
//   V1 Layer
//=================

ANT_V1 {
@ (V1 area / gate area) >= 20 (without effective diode).
@ (V1 area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  NET AREA RATIO GT M1 V1 M1_DIO  GATE > 20
    [ AREA(V1)/AREA(GATE) -(AREA(M1_DIO)*200+ !!AREA(M1_DIO)*980)  ] 
  RDB ANT_GT_V1.rep GT M1 V1 M1_DIO  GATE 
}
 AC_CORE_1 = NET AREA RATIO  M1 GATE_CORE >= 0 ACCUMULATE
 AC_IO_1 = NET AREA RATIO  M1 GATE_IO >= 0 ACCUMULATE
}

set metal_list "M1"

if { ([string equal $top_metal MT1] == 1) || ([string equal $top_metal MTT1] == 1) } {

#//=================
#//     one_mask
#//=================

VERBATIM {
#IFDEF MIM one_mask
}
 for { set j 2 } { $j < [expr $metal_counts-1] } { incr j } {
   CONNECT M$j M[expr $j - 1] BY V[expr $j - 1] 
   CONNECT M$j V$j
   lappend metal_list M$j
   SETLAYER M${j}_DIO = NET AREA SD > 0.16
   
RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO 
}

RULECHECK ANT_V${j} {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO V$j  GATE > 20 \[ AREA(V${j})/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V${j}.rep GT $metal_list M${j}_DIO V$j  GATE 
}
SETLAYER AC_CORE_${j} = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER AC_IO_${j} = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]
}

#//=====================
#//  Mn-1(M7)
#//=====================

CONNECT M$j M[expr $j-1] BY V[expr $j-1]
CONNECT M$j TV2_NOT_MIM
SETLAYER M${j}_DIO = NET AREA SD > 0.16
lappend metal_list M$j

RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j - 1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE 
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j - 1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO 
}

RULECHECK ANT_TV2 {
@ (TV2 area / gate area) >= 20 (without effective diode).
@ (TV2 area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO TV2_NOT_MIM  GATE > 20 \[ AREA(TV2_NOT_MIM)/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_TV2.rep GT $metal_list M${j}_DIO TV2_NOT_MIM  GATE 
}

SETLAYER TAC_CORE = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER TAC_IO = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]
#//=====================
#//  Mn(TM2)
#//=====================

CONNECT TM2 M$j BY TV2_NOT_MIM
CONNECT TM2 MIM BY TV2_AND_MIM
SETLAYER TM2_DIO = NET AREA SD > 0.16
lappend metal_list TM2

RULECHECK ANT_TM2_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_CORE > 5000 ACCUMULATE TAC_CORE \[ AREA(TM2) /AREA(GATE_CORE) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*50000) \]
  OUTLAYER RDB ANT_TM2_thin.rep $metal_list TM2_DIO GATE_CORE
}

RULECHECK ANT_TM2_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_IO > 600 ACCUMULATE TAC_IO \[ AREA(TM2) /AREA(GATE_IO) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*54400) \]
  OUTLAYER RDB ANT_TM2_thick.rep $metal_list TM2_DIO GATE_IO
}
VERBATIM {
#ENDIF
}
#//=================
#//     two_mask
#//=================
set metal_list "M1"
VERBATIM {
#IFDEF MIM two_mask
}

for { set j 2 } { $j < [expr $metal_counts-2] } { incr j } {
   CONNECT M$j M[expr $j-1] BY V[expr $j-1] 
   CONNECT M$j V$j
   lappend metal_list M$j
   SETLAYER M${j}_DIO = NET AREA SD > 0.16
   
RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO
}

RULECHECK ANT_V${j} {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO V$j  GATE > 20 \[ AREA(V${j})/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V${j}.rep GT $metal_list M${j}_DIO V$j  GATE 
}
SETLAYER AC_CORE_${j} = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER AC_IO_${j} = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]
}

#//=====================
#//  Mn-2(M6)
#//=====================

  CONNECT M$j M[expr $j-1] BY V[expr $j-1]
  CONNECT M$j V${j}_NOT_MIM
  SETLAYER M${j}_DIO = NET AREA SD > 0.16
  lappend metal_list M$j

RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO 
}

RULECHECK ANT_V${j} {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO V${j}_NOT_MIM  GATE > 20 \[ AREA(V${j}_NOT_MIM)/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V${j}.rep GT $metal_list M${j}_DIO V${j}_NOT_MIM  GATE 
}

SETLAYER AC_CORE_${j} = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER AC_IO_${j} = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]

#//=====================
#//  Mn-1(M7)
#//=====================

  CONNECT M[expr $j+1] M$j BY V${j}_NOT_MIM
  CONNECT M[expr $j+1] MIM BY V${j}_AND_MIM
  CONNECT M[expr $j+1] P2 BY V${j}_AND_P2
  CONNECT M[expr $j+1] TV2
  SETLAYER M[expr $j+1]_DIO = NET AREA SD > 0.16
  lappend metal_list M[expr $j+1]

RULECHECK ANT_M[expr $j+1]_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M[expr $j+1]_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_$j \[ AREA(M[expr $j+1]) /AREA(GATE_CORE) -(AREA(M[expr $j+1]_DIO)*400 + !!AREA(M[expr $j+1]_DIO)*39000) \]
  OUTLAYER RDB ANT_M[expr $j+1]_thin.rep $metal_list M[expr $j+1]_DIO GATE_CORE
}

RULECHECK ANT_M[expr $j+1]_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M[expr $j+1]_DIO GATE_IO > 600 ACCUMULATE AC_IO_$j \[ AREA(M[expr $j+1]) /AREA(GATE_IO) -(AREA(M[expr $j+1]_DIO)*400 + !!AREA(M[expr $j+1]_DIO)*43400) \]
  OUTLAYER RDB ANT_M[expr $j+1]_thick.rep $metal_list M[expr $j+1]_DIO GATE_IO 
}

RULECHECK ANT_TV2 {
@ (TV2 area / gate area) >= 20 (without effective diode).
@ (TV2 area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M[expr $j+1]_DIO TV2  GATE > 20 \[ AREA(TV2)/AREA(GATE) -(AREA(M[expr $j+1]_DIO)*200+ !!AREA(M[expr $j+1]_DIO)*980)  \] 
  OUTLAYER  RDB ANT_TV2.rep GT $metal_list M[expr $j+1]_DIO TV2  GATE 
}

SETLAYER TAC_CORE = NET AREA RATIO  M[expr $j+1] GATE_CORE >= 0 ACCUMULATE AC_CORE_$j
SETLAYER TAC_IO = NET AREA RATIO  M[expr $j+1] GATE_IO >= 0 ACCUMULATE AC_IO_$j

#//=====================
#//  Mn(TM2)
#//=====================

CONNECT TM2 M[expr $j+1] BY TV2
SETLAYER TM2_DIO = NET AREA SD > 0.16
lappend metal_list TM2

RULECHECK ANT_TM2_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_CORE > 5000 ACCUMULATE TAC_CORE \[ AREA(TM2) /AREA(GATE_CORE) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*50000) \]
  OUTLAYER RDB ANT_TM2_thin.rep $metal_list TM2_DIO GATE_CORE
}

RULECHECK ANT_TM2_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_IO > 600 ACCUMULATE TAC_IO \[ AREA(TM2) /AREA(GATE_IO) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*54400) \]
  OUTLAYER RDB ANT_TM2_thick.rep $metal_list TM2_DIO GATE_IO
}
VERBATIM {
#ENDIF
}
#//=================
#//     s_mask
#//=================
set metal_list "M1"
VERBATIM {
#IFDEF MIM s_mask
}

for { set j 2 } { $j < [expr $metal_counts-3] } { incr j } {
   CONNECT M$j M[expr $j - 1] BY V[expr $j - 1] 
   CONNECT M$j V$j
   lappend metal_list M$j
   SETLAYER M${j}_DIO = NET AREA SD > 0.16
   
RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO 
}

RULECHECK ANT_V${j} {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO V$j  GATE > 20 \[ AREA(V${j})/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V${j}.rep GT $metal_list M${j}_DIO V$j  GATE 
}
SETLAYER AC_CORE_${j} = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER AC_IO_${j} = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]
}

#//=====================
#//  Mn-3(M5)
#//=====================

  CONNECT M$j M[expr $j-1] BY V[expr $j-1]
  CONNECT M$j V${j}_NOT_MIM
  CONNECT M$j MIM_bot2
  SETLAYER M${j}_DIO = NET AREA SD > 0.16
  lappend metal_list M$j

RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO 
}

RULECHECK ANT_V${j} {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO V${j}_NOT_MIM  GATE > 20 \[ AREA(V${j}_NOT_MIM)/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V${j}.rep GT $metal_list M${j}_DIO V${j}_NOT_MIM  GATE 
}

SETLAYER AC_CORE_${j} = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER AC_IO_${j} = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]

#//=====================
#//  Mn-2(M6)
#//=====================

  CONNECT M[expr $j+1] M$j BY V${j}_NOT_MIM
  CONNECT M[expr $j+1] MIM BY V${j}_AND_MIM
  CONNECT M[expr $j+1] MIM_bot1
  CONNECT M[expr $j+1] V[expr $j+1]_NOT_MIM
  SETLAYER M[expr $j+1]_DIO = NET AREA SD > 0.16
  lappend metal_list M[expr $j+1]

RULECHECK ANT_M[expr $j+1]_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M[expr $j+1]_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_$j \[ AREA(M[expr $j+1]) /AREA(GATE_CORE) -(AREA(M[expr $j+1]_DIO)*400 + !!AREA(M[expr $j+1]_DIO)*39000) \]
  OUTLAYER RDB ANT_M[expr $j+1]_thin.rep $metal_list M[expr $j+1]_DIO GATE_CORE
}

RULECHECK ANT_M[expr $j+1]_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M[expr $j+1]_DIO GATE_IO > 600 ACCUMULATE AC_IO_$j \[ AREA(M[expr $j+1]) /AREA(GATE_IO) -(AREA(M[expr $j+1]_DIO)*400 + !!AREA(M[expr $j+1]_DIO)*43400) \]
  OUTLAYER RDB ANT_M[expr $j+1]_thick.rep $metal_list M[expr $j+1]_DIO GATE_IO 
}

RULECHECK ANT_V[expr $j+1] {
@ (V[expr $j+1] area / gate area) >= 20 (without effective diode).
@ (V[expr $j+1] area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M[expr $j+1]_DIO V[expr $j+1]_NOT_MIM  GATE > 20 \[ AREA(V[expr $j+1]_NOT_MIM)/AREA(GATE) -(AREA(M[expr $j+1]_DIO)*200+ !!AREA(M[expr $j+1]_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V[expr $j+1].rep GT $metal_list M[expr $j+1]_DIO V[expr $j+1]_NOT_MIM  GATE 
}

SETLAYER AC_CORE_[expr $j+1] = NET AREA RATIO  M[expr $j+1] GATE_CORE >= 0 ACCUMULATE AC_CORE_$j
SETLAYER AC_IO_[expr $j+1] = NET AREA RATIO  M[expr $j+1] GATE_IO >= 0 ACCUMULATE AC_IO_$j

#//=====================
#//  Mn-1(M7)
#//=====================

  CONNECT M[expr $j+2] M[expr $j+1] BY V[expr $j+1]_NOT_MIM
  CONNECT M[expr $j+2] MIM BY V[expr $j+1]_AND_MIM
  CONNECT M[expr $j+2] TV2
  SETLAYER M[expr $j+2]_DIO = NET AREA SD > 0.16
  lappend metal_list M[expr $j+2]

RULECHECK ANT_M[expr $j+2]_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M[expr $j+2]_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j+1] \[ AREA(M[expr $j+2]) /AREA(GATE_CORE) -(AREA(M[expr $j+2]_DIO)*400 + !!AREA(M[expr $j+2]_DIO)*39000) \]
  OUTLAYER RDB ANT_M[expr $j+2]_thin.rep $metal_list M[expr $j+2]_DIO GATE_CORE
}

RULECHECK ANT_M[expr $j+2]_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M[expr $j+2]_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j+1] \[ AREA(M[expr $j+2]) /AREA(GATE_IO) -(AREA(M[expr $j+2]_DIO)*400 + !!AREA(M[expr $j+2]_DIO)*43400) \]
  OUTLAYER RDB ANT_M[expr $j+2]_thick.rep $metal_list M[expr $j+2]_DIO GATE_IO 
}


RULECHECK ANT_TV2 {
@ (TV2 area / gate area) >= 20 (without effective diode).
@ (TV2 area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M[expr $j+2]_DIO TV2  GATE > 20 \[ AREA(TV2)/AREA(GATE) -(AREA(M[expr $j+2]_DIO)*200+ !!AREA(M[expr $j+2]_DIO)*980)  \] 
  OUTLAYER  RDB ANT_TV2.rep GT $metal_list M[expr $j+2]_DIO TV2  GATE 
}

SETLAYER TAC_CORE = NET AREA RATIO  M[expr $j+2] GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j+1]
SETLAYER TAC_IO = NET AREA RATIO  M[expr $j+2] GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j+1]

#//=====================
#//  Mn(TM2)
#//=====================

CONNECT TM2 M[expr $j+2] BY TV2
SETLAYER TM2_DIO = NET AREA SD > 0.16
lappend metal_list TM2

RULECHECK ANT_TM2_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_CORE > 5000 ACCUMULATE TAC_CORE \[ AREA(TM2) /AREA(GATE_CORE) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*50000) \]
  OUTLAYER RDB ANT_TM2_thin.rep $metal_list TM2_DIO GATE_CORE
}

RULECHECK ANT_TM2_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_IO > 600 ACCUMULATE TAC_IO \[ AREA(TM2) /AREA(GATE_IO) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*54400) \]
  OUTLAYER RDB ANT_TM2_thick.rep $metal_list TM2_DIO GATE_IO
}
VERBATIM {
#ENDIF
} 


} elseif { [string equal $top_metal MT2] == 1 } {

#//=====================
#//     one_mask
#//=====================
 VERBATIM {
#IFDEF MIM one_mask
}
   for { set j 2 } { $j < [expr $metal_counts-2] } { incr j } {
     CONNECT M$j M[expr $j - 1] BY V[expr $j - 1] 
     CONNECT M$j V$j
     lappend metal_list M$j
     SETLAYER M${j}_DIO = NET AREA SD > 0.16

RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j - 1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j - 1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO 
}

RULECHECK ANT_V${j} {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO V$j  GATE > 20 \[ AREA(V${j})/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V${j}.rep GT $metal_list M${j}_DIO V$j  GATE 
}
SETLAYER AC_CORE_${j} = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER AC_IO_${j} = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]
}

#//=====================
#//  Mn-2(M6)
#//=====================

  CONNECT M$j M[expr $j-1] BY V[expr $j-1]
  CONNECT M$j TV1_NOT_MIM
  SETLAYER M${j}_DIO = NET AREA SD > 0.16
  lappend metal_list M$j

RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j-1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO 
}

RULECHECK ANT_TV1 {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO TV1_NOT_MIM  GATE > 20 \[ AREA(TV1_NOT_MIM)/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V${j}.rep GT $metal_list M${j}_DIO TV1_NOT_MIM  GATE 
}

SETLAYER AC_CORE_${j} = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER AC_IO_${j} = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]

#//=====================
#//  Mn-1(TM1)
#//=====================

  CONNECT TM1 M$j BY TV1_NOT_MIM
  CONNECT TM1 MIM BY TV1_AND_MIM
  CONNECT TM1 TV2
  SETLAYER TM1_DIO = NET AREA SD > 0.16
  lappend metal_list TM1

RULECHECK ANT_TM1_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM1_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_$j \[ AREA(TM1) /AREA(GATE_CORE) -(AREA(TM1_DIO)*7800 + !!AREA(TM1_DIO)*50000) \]
  OUTLAYER RDB ANT_TM1_thin.rep $metal_list TM1_DIO GATE_CORE
}

RULECHECK ANT_TM1_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM1_DIO GATE_IO > 600 ACCUMULATE AC_IO_$j \[ AREA(TM1) /AREA(GATE_IO) -(AREA(TM1_DIO)*7800 + !!AREA(TM1_DIO)*54400) \]
  OUTLAYER RDB ANT_TM1_thick.rep $metal_list TM1_DIO GATE_IO 
}

RULECHECK ANT_TV2 {
@ (TV2 area / gate area) >= 20 (without effective diode).
@ (TV2 area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list TM1_DIO TV2 GATE > 20 \[ AREA(TV2)/AREA(GATE) -(AREA(TM1_DIO)*200+ !!AREA(TM1_DIO)*980)  \] 
  OUTLAYER  RDB ANT_TV2.rep GT $metal_list TM1_DIO TV2  GATE 
}

SETLAYER TAC_CORE = NET AREA RATIO  TM1 GATE_CORE >= 0 ACCUMULATE AC_CORE_$j
SETLAYER TAC_IO = NET AREA RATIO  TM1 GATE_IO >= 0 ACCUMULATE AC_IO_$j

#//=====================
#//  Mn(TM2)
#//=====================

CONNECT TM2 TM1 BY TV2
SETLAYER TM2_DIO = NET AREA SD > 0.16
lappend metal_list TM2

RULECHECK ANT_TM2_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_CORE > 5000 ACCUMULATE TAC_CORE \[ AREA(TM2) /AREA(GATE_CORE) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*50000) \]
  OUTLAYER RDB ANT_TM2_thin.rep $metal_list TM2_DIO GATE_CORE
}

RULECHECK ANT_TM2_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_IO > 600 ACCUMULATE TAC_IO \[ AREA(TM2) /AREA(GATE_IO) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*54400) \]
  OUTLAYER RDB ANT_TM2_thick.rep $metal_list TM2_DIO GATE_IO
}
VERBATIM {
#ENDIF
}

#//=================
#//     two_mask
#//=================
set metal_list "M1"
VERBATIM {
#IFDEF MIM two_mask
}
for { set j 2 } { $j < [expr $metal_counts-3] } { incr j } {
     CONNECT M$j M[expr $j - 1] BY V[expr $j - 1] 
     CONNECT M$j V$j
     lappend metal_list M$j
     SETLAYER M${j}_DIO = NET AREA SD > 0.16

RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j - 1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j - 1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO 
}

RULECHECK ANT_V${j} {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO V$j  GATE > 20 \[ AREA(V${j})/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V${j}.rep GT $metal_list M${j}_DIO V$j  GATE 
}
SETLAYER AC_CORE_${j} = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER AC_IO_${j} = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]
}

#//=====================
#//  Mn-3(M5)
#//=====================

  CONNECT M$j M[expr $j-1] BY V[expr $j-1]
  CONNECT M$j V$j
  SETLAYER M${j}_DIO = NET AREA SD > 0.16
  lappend metal_list M$j

RULECHECK ANT_M${j}_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j - 1] \[ AREA(M${j}) /AREA(GATE_CORE) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*39000) \]
  OUTLAYER RDB ANT_M${j}_thin.rep $metal_list M${j}_DIO GATE_CORE
}

RULECHECK ANT_M${j}_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M${j}_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j - 1] \[ AREA(M${j}) /AREA(GATE_IO) -(AREA(M${j}_DIO)*400 + !!AREA(M${j}_DIO)*43400) \]
  OUTLAYER RDB ANT_M${j}_thick.rep $metal_list M${j}_DIO GATE_IO 
}

RULECHECK ANT_V${j} {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M${j}_DIO V$j GATE > 20 \[ AREA(V${j})/AREA(GATE) -(AREA(M${j}_DIO)*200+ !!AREA(M${j}_DIO)*980)  \] 
  OUTLAYER  RDB ANT_V${j}.rep GT $metal_list M${j}_DIO V$j GATE 
}

SETLAYER AC_CORE_${j} = NET AREA RATIO  M${j} GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j-1]
SETLAYER AC_IO_${j} = NET AREA RATIO  M${j} GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j-1]

#//=====================
#//  Mn-2(M6)
#//=====================

  CONNECT M[expr $j+1] M$j BY V$j
  CONNECT M[expr $j+1] TV1_NOT_MIM
  SETLAYER M[expr $j+1]_DIO = NET AREA SD > 0.16
  lappend metal_list M[expr $j+1]

RULECHECK ANT_M[expr $j+1]_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 400 + 44000)

  OUTLAYER NET AREA RATIO GT $metal_list M[expr $j+1]_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_$j \[ AREA(M[expr $j+1]) /AREA(GATE_CORE) -(AREA(M[expr $j+1]_DIO)*400 + !!AREA(M[expr $j+1]_DIO)*39000) \]
  OUTLAYER RDB ANT_M[expr $j+1]_thin.rep $metal_list M[expr $j+1]_DIO GATE_CORE
}

RULECHECK ANT_M[expr $j+1]_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.diode area * 400 + 44000

  OUTLAYER NET AREA RATIO GT $metal_list M[expr $j+1]_DIO GATE_IO > 600 ACCUMULATE AC_IO_$j \[ AREA(M[expr $j+1]) /AREA(GATE_IO) -(AREA(M[expr $j+1]_DIO)*400 + !!AREA(M[expr $j+1]_DIO)*43400) \]
  OUTLAYER RDB ANT_M[expr $j+1]_thick.rep $metal_list M[expr $j+1]_DIO GATE_IO 
}

RULECHECK ANT_TV1 {
@ (V$j area / gate area) >= 20 (without effective diode).
@ (V$j area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list M[expr $j+1]_DIO TV1_NOT_MIM  GATE > 20 \[ AREA(TV1_NOT_MIM)/AREA(GATE) -(AREA(M[expr $j+1]_DIO)*200+ !!AREA(M[expr $j+1]_DIO)*980)  \] 
  OUTLAYER  RDB ANT_TV1.rep GT $metal_list M[expr $j+1]_DIO TV1_NOT_MIM  GATE 
}

SETLAYER AC_CORE_[expr $j+1] = NET AREA RATIO  M[expr $j+1] GATE_CORE >= 0 ACCUMULATE AC_CORE_$j
SETLAYER AC_IO_[expr $j+1] = NET AREA RATIO  M[expr $j+1] GATE_IO >= 0 ACCUMULATE AC_IO_$j

#//=====================
#//  Mn-1(TM1)
#//=====================

  CONNECT TM1 M[expr $j+1] BY TV1_NOT_MIM
  CONNECT TM1 MIM BY TV1_AND_MIM
  CONNECT TM1 P2 BY TV1_AND_P2
  CONNECT TM1 TV2
  SETLAYER TM1_DIO = NET AREA SD > 0.16
  lappend metal_list TM1

RULECHECK ANT_TM1_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM1_DIO GATE_CORE > 5000 ACCUMULATE AC_CORE_[expr $j+1] \[ AREA(TM1) /AREA(GATE_CORE) -(AREA(TM1_DIO)*7800 + !!AREA(TM1_DIO)*50000) \]
  OUTLAYER RDB ANT_TM1_thin.rep $metal_list TM1_DIO GATE_CORE
}

RULECHECK ANT_TM1_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM1_DIO GATE_IO > 600 ACCUMULATE AC_IO_[expr $j+1] \[ AREA(TM1) /AREA(GATE_IO) -(AREA(TM1_DIO)*7800 + !!AREA(TM1_DIO)*54400) \]
  OUTLAYER RDB ANT_TM1_thick.rep $metal_list TM1_DIO GATE_IO 
}

RULECHECK ANT_TV2 {
@ (TV2 area / gate area) >= 20 (without effective diode).
@ (TV2 area / gate area) > Ratio Equation (with effective diode). (diode area)*200 + 1000

  OUTLAYER  NET AREA RATIO GT $metal_list TM1_DIO TV2 GATE > 20 \[ AREA(TV2)/AREA(GATE) -(AREA(TM1_DIO)*200+ !!AREA(TM1_DIO)*980)  \] 
  OUTLAYER  RDB ANT_TV2.rep GT $metal_list TM1_DIO TV2  GATE 
}

SETLAYER TAC_CORE = NET AREA RATIO  TM1 GATE_CORE >= 0 ACCUMULATE AC_CORE_[expr $j+1]
SETLAYER TAC_IO = NET AREA RATIO  TM1 GATE_IO >= 0 ACCUMULATE AC_IO_[expr $j+1]

#//=====================
#//  Mn(TM2)
#//=====================

CONNECT TM2 TM1 BY TV2
SETLAYER TM2_DIO = NET AREA SD > 0.16
lappend metal_list TM2

RULECHECK ANT_TM2_thin {
@ The maximum ratio of cumulative metal area to the thin active poly gate area(without effective diode) is 5000;
@ The maximum ratio of cumulative metal area to the thin active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_CORE > 5000 ACCUMULATE TAC_CORE \[ AREA(TM2) /AREA(GATE_CORE) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*50000) \]
  OUTLAYER RDB ANT_TM2_thin.rep $metal_list TM2_DIO GATE_CORE
}

RULECHECK ANT_TM2_thick {
@ The maximum ratio of cumulative metal area to the thick active poly gate area(without effective diode) is 600;
@ The maximum ratio of cumulative metal area to the thick active poly gate area(with effective diode) is Ratio Equation.(diode area * 7800 + 55000)

  OUTLAYER NET AREA RATIO GT $metal_list TM2_DIO GATE_IO > 600 ACCUMULATE TAC_IO \[ AREA(TM2) /AREA(GATE_IO) -(AREA(TM2_DIO)*7800 + !!AREA(TM2_DIO)*54400) \]
  OUTLAYER RDB ANT_TM2_thick.rep $metal_list TM2_DIO GATE_IO
}
VERBATIM {
#ENDIF
}
}


